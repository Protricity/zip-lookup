/*
 * $.zipLookup v0.1
 *   - by Ari Asulin (ari.asulin at gmail.com)
 *   - jQuery plugin to dynamically fill in City/State Form Fields using an ajax Zipcode lookup
 *   - Apache License, Version 2.0
 *
 */
!function(){function s(a){return a.toLowerCase().replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function(a){return a.toUpperCase()})}var a=!1,b=2,c="zip-lookup-field-zipcode",d="zip-lookup-field-city",e="zip-lookup-field-city-title-case",f="zip-lookup-field-state",g="zip-lookup-field-state-short",h="zip-lookup-message",i=function(a,b){if("select"===a.nodeName.toLowerCase())for(var c=a.getElementsByTagName("option"),d=0;d<c.length;d++)if(c[d].value===b||c[d].innerHTML===b)return void(a.selectedIndex=d);"input"===a.nodeName.toLowerCase()?a.setAttribute("value",b):a.setAttribute("data-value",b)},j=function(a,b){return new RegExp("(^|\\s)"+b+"(\\s|$)","i").test(a.className)},k=function(a,b){j(a,b)||(a.className+=(a.className?" ":"")+b)},l=function(a,b){j(a,b)&&(a.className=a.className.replace(new RegExp("(^|\\s)"+b+"(\\s|$)","i"),""))},m=function(a,b){var c;return document.createEvent?(c=document.createEvent("HTMLEvents"),c.initEvent(b,!0,!0)):c=document.createEventObject(),c.eventName=b,document.createEvent?a.dispatchEvent(c):a.fireEvent("on"+b,c),c},n=function(a,b){a===document&&(a=document.body);for(var c=0;c<a.children.length;c++){var d=a.children[c];if(b&&b(d)===!0)return!1;if(n(d,b)===!1)return!1}return!0},o=function(a,b){if(a===document.body||a===document)return!1;var c=a.parentNode;return(!b||b(c)!==!0)&&o(c,b)},p=function(c,d){var e=this;this.country=d||"us";var f=document.getElementsByTagName("head")[0],g="zip-lookup/db";n(f,function(b){if("SCRIPT"===b.nodeName.toUpperCase()&&b.getAttribute("src")&&b.getAttribute("src").match(/zip-lookup(?:\.min)?\.js$/i))return g=b.getAttribute("src").replace(/zip-lookup(?:\.min)?\.js$/i,"db"),a&&console.log("Library path set: "+g),f=b.parentNode,!0});var h=function(a,b,c){};this.onSuccess=function(a){return h=a,e};var i=function(a){};this.onError=function(a){return i=a,e};var j=c.substring(0,b),k=c.substring(b),l=g+"/"+this.country+"/"+j+".js",m=document.createElement("script");m.src=l,m.type="text/javascript",m.async=!0,f.appendChild(m);var o=setTimeout(function(){i("Search Timed out")},3e3);return window.__zl=function(a){if(clearTimeout(o),void 0===a||void 0===a[0])return i("Zipcode Not Found in DB");var b=a[0][k];if(void 0===a[1][b])return i("Zipcode City Not Found in DB");var c=a[1][b].split("|"),d=c[0];c[1]||(c[1]=0);var e=c[1],f=a[2][e].split("|"),g=f[1],j=f[0];h(d,g,j)},this},q=document.getElementsByClassName(h),r=function(a){switch(a.type){case"blur":case"change":if(j(a.target,c)){var b=a.target.value,r="undefined"==typeof a.target.lastVal?null:a.target.lastVal;b&&b!==r&&(a.target.lastVal=b,m(a.target,"zip-lookup"))}break;case"zip-lookup":var t=a.target?a.target.value.trim():null,u=a.target.form||document;o(a.target,function(a){if("fieldset"===a.nodeName.toLowerCase()||a===u)return u=a,!0});for(var v=0;v<q.length;v++)(function(a){a.innerHTML="Searching...",l(a,"error")})(q[v]);p(t).onError(function(b){a.target.setAttribute("zip-lookup-error-message",b),m(a.target,"zip-lookup-error");for(var c=0;c<q.length;c++)(function(a){a.innerHTML=b,k(a,"error")})(q[c])}).onSuccess(function(b,c,k){console.info("Location Chosen: ",t,b,c,k),n(u,function(a){j(a,d)&&i(a,b),j(a,e)&&i(a,s(b)),j(a,f)&&i(a,c),j(a,g)&&i(a,k),j(a,h)&&(a.innerHTML="Result found - "+b+", "+k,l(a,"error"))}),a.target.setAttribute("data-city-name",b),a.target.setAttribute("data-state-name",c),a.target.setAttribute("data-state-short-name",k),m(a.target,"zip-lookup-found");for(var o=0;o<q.length;o++)(function(a){a.innerHTML="Found "+s(b)+", "+c,l(a,"error")})(q[o])})}};document.addEventListener("blur",r),document.addEventListener("change",r),document.addEventListener("zip-lookup",r)}();