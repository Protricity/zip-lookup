/*
 * $.zipLookup v0.1
 *   - by Ari Asulin (ari.asulin at gmail.com)
 *   - jQuery plugin to dynamically fill in City/State Form Fields using an ajax Zipcode lookup
 *   - Apache License, Version 2.0
 *
 */
!function(){function e(e){return e.toLowerCase().replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function(e){return e.toUpperCase()})}var t=!1,n=2,r="zip-lookup-field-zipcode",o="zip-lookup-field-city",a="zip-lookup-field-city-title-case",i="zip-lookup-field-state",u="zip-lookup-field-state-short",c="zip-lookup-message",s=function(e,t){if("select"===e.nodeName.toLowerCase())for(var n=e.getElementsByTagName("option"),r=0;r<n.length;r++)if(n[r].value===t||n[r].innerHTML===t)return void(e.selectedIndex=r);"input"===e.nodeName.toLowerCase()?e.setAttribute("value",t):e.setAttribute("data-value",t)},l=function(e,t){return new RegExp("(^|\\s)"+t+"(\\s|$)","i").test(e.className)},d=function(e,t){l(e,t)||(e.className+=(e.className?" ":"")+t)},p=function(e,t){l(e,t)&&(e.className=e.className.replace(new RegExp("(^|\\s)"+t+"(\\s|$)","i"),""))},f=function(e,t){var n;return document.createEvent?(n=document.createEvent("HTMLEvents"),n.initEvent(t,!0,!0)):n=document.createEventObject(),n.eventName=t,document.createEvent?e.dispatchEvent(n):e.fireEvent("on"+t,n),n},m=function(e,t){e===document&&(e=document.body);for(var n=0;n<e.children.length;n++){var r=e.children[n];if(t&&t(r)===!0)return!1;if(m(r,t)===!1)return!1}return!0},v=function(e,t){if(e===document.body||e===document)return!1;var n=e.parentNode;return t&&t(n)===!0?!1:v(n,t)},g=function(e,r){var o=this;this.country=r||"us";var a=document.getElementsByTagName("head")[0],i="zip-lookup/db";m(a,function(e){return"SCRIPT"===e.nodeName.toUpperCase()&&e.getAttribute("src")&&e.getAttribute("src").match(/zip-lookup(?:\.min)?\.js$/i)?(i=e.getAttribute("src").replace(/zip-lookup(?:\.min)?\.js$/i,"db"),t&&console.log("Library path set: "+i),a=e.parentNode,!0):void 0});var u=function(){};this.onSuccess=function(e){return u=e,o};var c=function(){};this.onError=function(e){return c=e,o};var s=e.substring(0,n),l=e.substring(n),d=i+"/"+this.country+"/"+s+".js",p=document.createElement("script");p.src=d,p.type="text/javascript",p.async=!0,a.appendChild(p);var f=setTimeout(function(){c("Search Timed out")},3e3);return window.__zl=function(e){if(clearTimeout(f),void 0===e||void 0===e[0])return c("Zipcode Not Found in DB");var t=e[0][l];if(void 0===e[1][t])return c("Zipcode City Not Found in DB");var n=e[1][t].split("|"),r=n[0];n[1]||(n[1]=0);var o=n[1],a=e[2][o].split("|"),i=a[1],s=a[0];u(r,i,s)},this},h=document.getElementsByClassName(c),E=function(t){switch(t.type){case"blur":case"change":if(l(t.target,r)){var n=t.target.value,E="undefined"==typeof t.target.lastVal?null:t.target.lastVal;n&&n!==E&&(t.target.lastVal=n,f(t.target,"zip-lookup"))}break;case"zip-lookup":var b=t.target?t.target.value.trim():null,z=t.target.form||document;v(t.target,function(e){return"fieldset"===e.nodeName.toLowerCase()||e===z?(z=e,!0):void 0});for(var N=0;N<h.length;N++)(function(e){e.innerHTML="Searching...",p(e,"error")})(h[N]);g(b).onError(function(e){t.target.setAttribute("zip-lookup-error-message",e),f(t.target,"zip-lookup-error");for(var n=0;n<h.length;n++)(function(t){t.innerHTML=e,d(t,"error")})(h[n])}).onSuccess(function(n,r,d){m(z,function(t){l(t,o)&&s(t,n),l(t,a)&&s(t,e(n)),l(t,i)&&s(t,r),l(t,u)&&s(t,d),l(t,c)&&(t.innerHTML="Result found - "+n+", "+d,p(t,"error"))}),t.target.setAttribute("data-city-name",n),t.target.setAttribute("data-state-name",r),t.target.setAttribute("data-state-short-name",d),f(t.target,"zip-lookup-found");for(var v=0;v<h.length;v++)(function(t){t.innerHTML="Found "+e(n)+", "+r,p(t,"error")})(h[v])})}};document.addEventListener("blur",E),document.addEventListener("change",E),document.addEventListener("zip-lookup",E)}();